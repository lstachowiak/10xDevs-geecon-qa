---
import Layout from "@/layouts/Layout.astro";
import { RegisterForm } from "@/components/auth/RegisterForm";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";

export const prerender = false;

const { url } = Astro;
const token = url.searchParams.get("token");

if (!token) {
  return Astro.redirect("/");
}

// Verify token
const { data: invite, error } = await Astro.locals.supabase
  .from("invites")
  .select("*")
  .eq("token", token)
  .eq("status", "active")
  .single();

let tokenError: string | null = null;
let email = "";

if (error || !invite) {
  tokenError = "Nieprawidłowy lub nieaktywny token zaproszenia";
} else if (new Date(invite.expires_at) < new Date()) {
  tokenError = "Token zaproszenia wygasł";
  // Mark as expired
  await Astro.locals.supabase
    .from("invites")
    .update({ status: "expired" })
    .eq("id", invite.id);
} else {
  // Extract email from token (if stored) or from query params
  email = url.searchParams.get("email") || "";
}
---

<Layout title="Rejestracja moderatora">
  <div class="container mx-auto py-8 max-w-md">
    <Card>
      <CardHeader>
        <CardTitle>Rejestracja moderatora</CardTitle>
        <CardDescription>
          {tokenError ? "Wystąpił problem z linkiem zaproszeniowym" : "Witaj! Uzupełnij poniższe dane, aby dokończyć rejestrację."}
        </CardDescription>
      </CardHeader>
      <CardContent>
        {
          tokenError ? (
            <div class="rounded-md bg-destructive/10 p-4">
              <p class="text-sm text-destructive text-center">{tokenError}</p>
              <div class="mt-4 text-center">
                <a href="/" class="text-sm text-primary hover:underline">
                  Wróć do strony głównej
                </a>
              </div>
            </div>
          ) : (
            <RegisterForm email={email} token={token} client:load />
          )
        }
      </CardContent>
    </Card>
  </div>
</Layout>
